<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FX Market | Dashboard</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #0f172a; color: white; margin: 0; padding: 20px; }
        .card { background: #1e293b; padding: 20px; border-radius: 15px; margin-bottom: 20px; border: 1px solid #334155; }
        .balance-box { text-align: center; background: linear-gradient(135deg, #38bdf8, #1d4ed8); color: white; }
        h1 { font-size: 2.5rem; margin: 10px 0; }
        .ref-box { background: #0f172a; padding: 15px; border-radius: 8px; border: 1px dashed #38bdf8; word-break: break-all; cursor: pointer; }
        .label { color: #94a3b8; font-size: 0.9rem; margin-bottom: 5px; }
        button { background: #38bdf8; color: #0f172a; border: none; padding: 12px; border-radius: 8px; font-weight: bold; width: 100%; cursor: pointer; margin-top: 10px; }
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
    </style>
</head>
<body>

    <div class="card balance-box">
        <div class="label" style="color: white; opacity: 0.8;">Total Balance (Live ROI)</div>
        <h1 id="totalBalance">$0.00</h1>
        <div class="stats-grid">
            <div>
                <div class="label" style="color: white;">Trading Capital</div>
                <div id="tradingCapital" style="font-weight: bold;">$0.00</div>
            </div>
            <div>
                <div class="label" style="color: white;">Daily ROI</div>
                <div style="font-weight: bold;">4.5%</div>
            </div>
        </div>
    </div>

    <div class="card">
        <h2>Your Referral Link</h2>
        <p class="label">Share this link to earn team commissions</p>
        <div class="ref-box" id="referralLink" onclick="copyLink()">Loading link...</div>
        <button onclick="copyLink()">Copy Referral Link</button>
    </div>

    <div class="card">
        <button onclick="window.location.href='deposit.html'" style="background: #22c55e; color: white;">Deposit Funds</button>
        <button onclick="window.location.href='withdraw.html'" style="background: #ef4444; color: white;">Withdraw Profits</button>
        <button onclick="firebase.auth().signOut()" style="background: #64748b; color: white; margin-top: 20px;">Logout</button>
    </div>

    <script>
        // YOUR FIREBASE CONFIG
        const firebaseConfig = {
          apiKey: "AIzaSyAjFTRa3-bnELvxH3Q4SqtqS47-foVxo38",
          authDomain: "forex-market-86c48.firebaseapp.com",
          projectId: "forex-market-86c48",
          storageBucket: "forex-market-86c48.firebasestorage.app",
          messagingSenderId: "830051911841",
          appId: "1:830051911841:web:c40bd03bed0613114248e0",
          measurementId: "G-WB9HQ1R6QJ"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        firebase.auth().onAuthStateChanged((user) => {
            if (user) {
                // Listen for data changes in real-time
                db.collection("users").doc(user.uid).onSnapshot((doc) => {
                    if (doc.exists) {
                        const data = doc.data();

                        // 1. GENERATE REFERRAL LINK
                        // This detects your current website address automatically
                        const currentUrl = window.location.href;
                        const baseUrl = currentUrl.substring(0, currentUrl.lastIndexOf('/')) + "/index.html";
                        const refLink = `${baseUrl}?ref=${data.username || 'user'}`;
                        document.getElementById('referralLink').innerText = refLink;

                        // 2. LIVE ROI CALCULATION (4.5% Daily)
                        if (data.investment && data.approvedDate) {
                            function updateLiveBalance() {
                                const investment = parseFloat(data.investment);
                                const startTimestamp = data.approvedDate.toDate().getTime();
                                const now = new Date().getTime();

                                // Calculate exact time difference in days (including decimals for smooth growth)
                                const diffDays = (now - startTimestamp) / (1000 * 60 * 60 * 24);
                                
                                // Profit = Capital * 4.5% * Days
                                const profit = investment * 0.045 * diffDays;
                                const currentTotal = investment + profit;

                                document.getElementById('totalBalance').innerText = "$" + currentTotal.toFixed(4);
                                document.getElementById('tradingCapital').innerText = "$" + investment.toFixed(2);
                            }
                            
                            // Update every 1 second for a "Live" feel
                            setInterval(updateLiveBalance, 1000);
                            updateLiveBalance();
                        }
                    }
                });
            } else {
                window.location.href = "index.html";
            }
        });

        function copyLink() {
            const linkText = document.getElementById('referralLink').innerText;
            const tempInput = document.createElement("input");
            document.body.appendChild(tempInput);
            tempInput.value = linkText;
            tempInput.select();
            document.execCommand("copy");
            document.body.removeChild(tempInput);
            alert("Referral Link Copied!");
        }
    </script>
</body>
</html>
